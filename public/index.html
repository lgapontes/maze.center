<!DOCTYPE html>
<html>
	<head>
		<title>maze.center</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="css/reset.css">
		<link rel="stylesheet" type="text/css" href="css/main.css">		
		<script type="text/javascript" src="js/jquery-2.2.3.min.js"></script>
		<script type="text/javascript" src="js/frame-0.0.1.js"></script>
		<script type="text/javascript" src="js/restfull-building-0.0.1.js"></script>
		<script type="text/javascript" src="js/headsman-0.0.1.js"></script>		
		<script type="text/javascript" src="js/model-0.0.1.js"></script>		
	</head>
<body>
	<img id="bigJonny" src="img/bigJonny.png" style="display: none;">
	<img id="chest" src="img/chest.png" style="display: none;">
	<canvas id="canvas"></canvas>
	
	<script type="text/javascript">
		
		var DEBUG = {
			active: true,
			painted: false
		};
		
		/* Map */
		var map = undefined;
		
		/* Get canvas and context */
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");			
		
		/* Set size of canvas */
		canvas.width = window.innerWidth - 6;
		canvas.height = window.innerHeight - 6;
		var WIDTH = canvas.width;
		var HEIGHT = canvas.height;
		
		/* Images */
		var bigJonny, chest;
		window.onload = function() {			
			bigJonny = document.getElementById("bigJonny");
			chest = document.getElementById("chest");
		}
		
		/* Big Jonny position */
		var bigJonnyX = (WIDTH-bigJonny.width)/2;
		var bigJonnyY = (HEIGHT-bigJonny.height)/2;

		/* Collision and Winner check */
		var WON = false;
		var COL = false;
		var heldLock = false;
		
		/* Default value */
		var axis = undefined;
		var alignments = undefined;
		var thickness = undefined;
		var types = undefined;
		
		/* Objects to manage */
		var buildingFactory = new BuildingFactory();
		var headsman = new Headsman();
	
		(function() {
			/* Variables to check drag and if data was created */
			var dragok = false;		
			var dataCreated = false;
			
			/* Initial position */
			var initial_position_x = WIDTH/2;
			var initial_position_y = HEIGHT/2;
			
			/* Mouse drag */
			var x;
			var y;
			
			/* Click and touch controller */
			var clickY;
			var clickX;
			var touchX;
			var touchY;
			
			/* Diif to drag and drop */
			var diffY = 0;
			var diffX = 0;
			
			function data(callback) {		
				
				/* Places */				
				getBuilding(function(error,building){
					if (error) {
						console.log(error);
					} else {
					
						/* Map */
						map = building.map;
						console.log( map );
					
						/* Enuns */
						axis = building.axis;
						alignments = building.alignments;
						thickness = building.thickness;
						types = building.types;
					
						/* Places */
						building.places.forEach(function(entry){
							if (entry.type === types.room) {
								buildingFactory.add(new Room(entry));
							} else {
								buildingFactory.add(new Tower(entry));
							}							
						});
						buildingFactory.updateNeighbors();
						
						/* Set position */
						buildingFactory.getMaster().position.x = initial_position_x - buildingFactory.getMaster().size.width/2;
						buildingFactory.getMaster().position.y = initial_position_y - buildingFactory.getMaster().size.height/2;
												
						callback();
					}
				});
			};
			
			function draw() {
			
				/* Blocks Interactions */
				if (WON || COL) {
					
					if (!heldLock) {
						heldLock = true;
						
						if (WON) {							
							document.getElementById("overlay").style.background = wonColor;
							modal.open({
								content: 
									"Congratulations! Big Johnny won! xD<br /><br />" +
									"<a href='#' class='myButton' onclick='javascript:again()'>Again?</a>" +
									"<a href='#' class='myButton' style='float: right' onclick='javascript:next()'>Next level</a>"
							});
						}
						if (COL) {
							document.getElementById("overlay").style.background = collisionColor;
							modal.open({
								content: 
									"Big Jonny died!<br />" +
									"Try again and do not hit the walls...<br /><br />" +
									"<a href='#' class='myButton' onclick='javascript:again()'>Again?</a>"
							});
						}
					}
					
				} else {
				
					/* Clear */
					ctx.beginPath();
					ctx.fillStyle = clearColor;
					ctx.rect(0, 0, WIDTH, HEIGHT);
					ctx.closePath();
					ctx.fill();
					
					/* Draw */
					if (dataCreated) {
						buildingFactory.draw();
					}
					
					/* There was a collision? */
					COL = headsman.checkCollision();
					
					/* Big Jonny */
					ctx.drawImage(
						bigJonny,
						bigJonnyX,
						bigJonnyY
					);
				
				}
				
			};
			
			function myMove(e){
				/* Blocks Interactions */
				if (WON || COL) return;
			
				if (dragok){
					x = e.pageX;
					y = e.pageY;
					diffX = (x - clickX);
					diffY = (y - clickY);
					clickX = e.pageX;
					clickY = e.pageY;
					moveMap();
		
					/* Check jonny won */
					WON = headsman.johnnyWon();
				}
			};
			
			function myDown(e){
				/* Blocks Interactions */
				if (WON || COL) return;
			
				clickX = e.pageX;
				clickY = e.pageY;
				dragok = true;
				canvas.onmousemove = myMove;
			};

			function myUp(){
				/* Blocks Interactions */
				if (WON || COL) return;
			
				dragok = false;
				canvas.onmousemove = null;
			};
			
			function moveMap() {
				/* Blocks Interactions */
				if (WON || COL) return;
			
				initial_position_x = initial_position_x + diffX;
				initial_position_y = initial_position_y + diffY;
			
				/* Set position */
				buildingFactory.getMaster().position.x = initial_position_x - buildingFactory.getMaster().size.width/2;
				buildingFactory.getMaster().position.y = initial_position_y - buildingFactory.getMaster().size.height/2;
			};
			
			function startTouch(e){
				/* Blocks Interactions */
				if (WON || COL) return;
			
				touchX=e.touches[0].pageX;
				touchY=e.touches[0].pageY;
				dragok = true;
			};
			
			function endTouch(){
				dragok = false;
			};
			
			function moveTouch(e){
			
				/* Blocks Interactions */
				if (WON || COL) return;
			
				/* Prevent scrolling */
				e.preventDefault();
			
				if (dragok){
					x=e.touches[0].pageX;
					y=e.touches[0].pageY;
					diffX = (x - touchX);
					diffY = (y - touchY);
					touchX=e.touches[0].pageX;
					touchY=e.touches[0].pageY;
					moveMap();
					
					/* Check jonny won */
					WON = headsman.johnnyWon();
				}
			}
			
			function init() {
				data(function(){
					x = canvas.width/2 - buildingFactory.getMaster().size.width/2;
					y = canvas.height/2 - buildingFactory.getMaster().size.height/2;			
					clickX = 0;
					clickY = 0;
					touchX = 0;
					touchY = 0;
					moveMap();
					dataCreated = true;
					
					headsman.updateCorners(bigJonnyX,bigJonnyY);
				});
				
				return setInterval(draw, 10);
			}
			
			/* Draw */
			init();
			canvas.onmousedown = myDown;
			canvas.onmouseup = myUp;
			canvas.addEventListener('touchstart',startTouch);
			canvas.addEventListener('touchmove',moveTouch, false);
			canvas.addEventListener('touchend',endTouch);
			
		})();
	</script>
</body>
</html>